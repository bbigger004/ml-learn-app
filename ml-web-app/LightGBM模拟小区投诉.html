<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ•æ„Ÿäººç¾¤åŠ¨æ€ä¿ç”µ - æŠ•è¯‰é£é™©é¢„æµ‹</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.5.1"></script>
    <style>
      body {
        font-family: 'Microsoft YaHei', Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
        color: #2c3e50;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }
      .card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #3498db;
      }
      .card.high-risk {
        border-left-color: #e74c3c;
        background: #ffeaea;
      }
      .card.medium-risk {
        border-left-color: #f39c12;
        background: #fff3cd;
      }
      button {
        background: #3498db;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 5px;
      }
      button:hover {
        background: #2980b9;
      }
      button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }
      .risk-indicator {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        color: white;
        font-weight: bold;
        margin-left: 10px;
      }
      .risk-low {
        background: #27ae60;
      }
      .risk-medium {
        background: #f39c12;
      }
      .risk-high {
        background: #e74c3c;
      }
      .feature-importance {
        margin-top: 20px;
      }
      .feature-bar {
        display: flex;
        align-items: center;
        margin: 8px 0;
      }
      .feature-name {
        width: 200px;
        font-weight: bold;
      }
      .feature-value {
        flex-grow: 1;
        height: 20px;
        background: #ecf0f1;
        border-radius: 10px;
        overflow: hidden;
      }
      .feature-fill {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #2ecc71);
        transition: width 0.5s;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ  æ•æ„Ÿäººç¾¤åŠ¨æ€ä¿ç”µ - æŠ•è¯‰é£é™©é¢„æµ‹</h1>
        <p>åŸºäºLightGBMæ€æƒ³çš„TensorFlow.jsç¥ç»ç½‘ç»œé¢„æµ‹æ¨¡å‹</p>
      </div>

      <div class="grid">
        <div class="card">
          <h3>ğŸ“Š æ¨¡å‹è®­ç»ƒçŠ¶æ€</h3>
          <div id="trainingStatus">å‡†å¤‡å¼€å§‹è®­ç»ƒ...</div>
          <div id="trainingProgress"></div>
          <div id="modelMetrics"></div>
        </div>

        <div class="card">
          <h3>âš¡ å®æ—¶é¢„æµ‹æ§åˆ¶</h3>
          <button onclick="startTraining()">å¼€å§‹è®­ç»ƒæ¨¡å‹</button>
          <button onclick="generatePredictions()">ç”Ÿæˆç½‘æ ¼é¢„æµ‹</button>
          <button onclick="resetModel()">é‡ç½®æ¨¡å‹</button>
        </div>
      </div>

      <div class="card">
        <h3>ğŸ” é«˜é£é™©ç½‘æ ¼é¢„è­¦</h3>
        <div id="predictions"></div>
      </div>

      <div class="card">
        <h3>ğŸ“ˆ ç‰¹å¾é‡è¦æ€§åˆ†æ</h3>
        <div id="featureImportance" class="feature-importance"></div>
      </div>
    </div>

    <script>
      // æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå™¨
      class PowerGridDataGenerator {
        constructor() {
          this.features = [
            'population_density', // äººå£å¯†åº¦
            'load_rate', // è´Ÿè½½ç‡
            'historical_faults', // å†å²æ•…éšœæ•°
            'special_group_density', // ç‰¹æ®Šç¾¤ä½“å¯†åº¦
            'equipment_age', // è®¾å¤‡è€åŒ–ç¨‹åº¦
            'external_risk', // å¤–éƒ¨é£é™©
            'holiday_flag', // æ˜¯å¦èŠ‚å‡æ—¥
            'economic_level', // ç»æµæ°´å¹³
            'historical_complaints', // å†å²æŠ•è¯‰æ•°
            'temperature', // æ¸©åº¦
          ]
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿè®­ç»ƒæ•°æ®
        generateTrainingData(samples = 10000) {
          const features = []
          const labels = []

          for (let i = 0; i < samples; i++) {
            const sample = this.generateSample()
            features.push(sample.features)
            labels.push(sample.label)
          }

          return {
            features: tf.tensor2d(features),
            labels: tf.tensor1d(labels),
          }
        }

        // ç”Ÿæˆå•ä¸ªæ ·æœ¬
        generateSample() {
          // ç”Ÿæˆç¬¦åˆä¸šåŠ¡é€»è¾‘çš„ç‰¹å¾
          const populationDensity = Math.random() // äººå£å¯†åº¦ 0-1
          const loadRate = Math.random() // è´Ÿè½½ç‡ 0-1
          const historicalFaults = Math.floor(Math.random() * 10) // å†å²æ•…éšœæ•° 0-9
          const specialGroupDensity = Math.random() // ç‰¹æ®Šç¾¤ä½“å¯†åº¦ 0-1
          const equipmentAge = Math.random() // è®¾å¤‡è€åŒ–ç¨‹åº¦ 0-1
          const externalRisk = Math.random() // å¤–éƒ¨é£é™© 0-1
          const holidayFlag = Math.random() > 0.7 ? 1 : 0 // 30%æ¦‚ç‡æ˜¯èŠ‚å‡æ—¥
          const economicLevel = Math.random() // ç»æµæ°´å¹³ 0-1
          const historicalComplaints = Math.floor(Math.random() * 5) // å†å²æŠ•è¯‰æ•° 0-4
          const temperature = 20 + Math.random() * 30 // æ¸©åº¦ 20-50Â°C

          const features = [
            populationDensity,
            loadRate,
            historicalFaults / 10, // å½’ä¸€åŒ–
            specialGroupDensity,
            equipmentAge,
            externalRisk,
            holidayFlag,
            economicLevel,
            historicalComplaints / 5, // å½’ä¸€åŒ–
            (temperature - 20) / 30, // å½’ä¸€åŒ–åˆ° 0-1
          ]

          // åŸºäºä¸šåŠ¡è§„åˆ™ç”Ÿæˆæ ‡ç­¾ï¼ˆæ¨¡æ‹ŸçœŸå®æ¨¡å¼ï¼‰
          let complaintProbability = 0

          // æ ¸å¿ƒé©±åŠ¨å› å­æƒé‡è¾ƒé«˜
          complaintProbability += populationDensity * 0.15
          complaintProbability += loadRate * 0.2
          complaintProbability += (historicalFaults / 10) * 0.15
          complaintProbability += specialGroupDensity * 0.25

          // èƒŒæ™¯è°ƒèŠ‚å› å­
          complaintProbability += equipmentAge * 0.1
          complaintProbability += externalRisk * 0.08
          complaintProbability += holidayFlag * 0.05
          complaintProbability += economicLevel * 0.02

          // æ·»åŠ ä¸€äº›éšæœºå™ªå£°
          complaintProbability += (Math.random() - 0.5) * 0.1

          const label = complaintProbability > 0.5 ? 1 : 0

          return { features, label }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿé¢„æµ‹æ•°æ®ï¼ˆå½“å‰ç½‘æ ¼çŠ¶æ€ï¼‰
        generatePredictionData(gridCount = 20) {
          const grids = []
          for (let i = 0; i < gridCount; i++) {
            const sample = this.generateSample()
            grids.push({
              id: `GRID_${(i + 1).toString().padStart(3, '0')}`,
              features: sample.features,
              riskLevel: 'pending', // ç­‰å¾…é¢„æµ‹
            })
          }
          return grids
        }
      }

      // æŠ•è¯‰é¢„æµ‹æ¨¡å‹
      class ComplaintPredictionModel {
        constructor() {
          this.model = null
          this.isTrained = false
          this.trainingHistory = null
        }

        // åˆ›å»ºç¥ç»ç½‘ç»œæ¨¡å‹
        createModel() {
          const model = tf.sequential({
            layers: [
              // è¾“å…¥å±‚ï¼Œå¯¹åº”10ä¸ªç‰¹å¾
              tf.layers.dense({
                inputShape: [10],
                units: 64,
                activation: 'relu',
                kernelInitializer: 'heNormal',
              }),
              tf.layers.dropout({ rate: 0.3 }),

              // éšè—å±‚
              tf.layers.dense({
                units: 32,
                activation: 'relu',
              }),
              tf.layers.dropout({ rate: 0.2 }),

              // è¾“å‡ºå±‚ - äºŒåˆ†ç±»
              tf.layers.dense({
                units: 1,
                activation: 'sigmoid',
              }),
            ],
          })

          // ç¼–è¯‘æ¨¡å‹
          model.compile({
            optimizer: tf.train.adam(0.001),
            loss: 'binaryCrossentropy',
            metrics: ['accuracy'],
          })

          this.model = model
          return model
        }

        // è®­ç»ƒæ¨¡å‹
        async train(features, labels, epochs = 100) {
          if (!this.model) {
            this.createModel()
          }

          // æ‹†åˆ†è®­ç»ƒé›†å’ŒéªŒè¯é›†
          const splitIndex = Math.floor(features.shape[0] * 0.8)
          const trainFeatures = features.slice(0, splitIndex)
          const trainLabels = labels.slice(0, splitIndex)
          const valFeatures = features.slice(splitIndex)
          const valLabels = labels.slice(splitIndex)

          this.trainingHistory = await this.model.fit(
            trainFeatures,
            trainLabels,
            {
              epochs: epochs,
              validationData: [valFeatures, valLabels],
              batchSize: 32,
              callbacks: {
                onEpochEnd: async (epoch, logs) => {
                  // æ›´æ–°è®­ç»ƒçŠ¶æ€
                  document.getElementById(
                    'trainingStatus'
                  ).innerHTML = `è®­ç»ƒä¸­... ç¬¬ ${epoch + 1}/${epochs} è½®`
                  document.getElementById('trainingProgress').innerHTML =
                    `è®­ç»ƒå‡†ç¡®ç‡: ${logs.accuracy ? logs.accuracy.toFixed(4) : (logs.acc ? logs.acc.toFixed(4) : 'N/A')} | ` +
                    `éªŒè¯å‡†ç¡®ç‡: ${
                      logs.val_accuracy ? logs.val_accuracy.toFixed(4) : (logs.val_acc ? logs.val_acc.toFixed(4) : 'N/A')
                    }`

                  // å¼ºåˆ¶UIæ›´æ–°
                  await tf.nextFrame()
                },
              },
            }
          )

          this.isTrained = true
          return this.trainingHistory
        }

        // é¢„æµ‹ç½‘æ ¼é£é™©
        async predict(grids) {
          if (!this.isTrained) {
            throw new Error('æ¨¡å‹å°šæœªè®­ç»ƒï¼Œè¯·å…ˆè®­ç»ƒæ¨¡å‹')
          }

          const featuresArray = grids.map((grid) => grid.features)
          const featuresTensor = tf.tensor2d(featuresArray)

          const predictions = await this.model.predict(featuresTensor)
          const predictionData = await predictions.data()

          featuresTensor.dispose()
          predictions.dispose()

          // ä¸ºæ¯ä¸ªç½‘æ ¼æ·»åŠ é¢„æµ‹ç»“æœ
          return grids.map((grid, index) => {
            const riskScore = predictionData[index]
            let riskLevel, riskClass

            if (riskScore < 0.3) {
              riskLevel = 'ä½é£é™©'
              riskClass = 'risk-low'
            } else if (riskScore < 0.7) {
              riskLevel = 'ä¸­é£é™©'
              riskClass = 'risk-medium'
            } else {
              riskLevel = 'é«˜é£é™©'
              riskClass = 'risk-high'
            }

            return {
              ...grid,
              riskScore: riskScore,
              riskLevel: riskLevel,
              riskClass: riskClass,
            }
          })
        }

        // è®¡ç®—ç‰¹å¾é‡è¦æ€§ï¼ˆæ¨¡æ‹Ÿ - å®é™…éœ€è¦æ›´å¤æ‚çš„æ–¹æ³•ï¼‰
        getFeatureImportance() {
          const featureNames = [
            'äººå£å¯†åº¦',
            'è´Ÿè½½ç‡',
            'å†å²æ•…éšœæ•°',
            'ç‰¹æ®Šç¾¤ä½“å¯†åº¦',
            'è®¾å¤‡è€åŒ–ç¨‹åº¦',
            'å¤–éƒ¨é£é™©',
            'æ˜¯å¦èŠ‚å‡æ—¥',
            'ç»æµæ°´å¹³',
            'å†å²æŠ•è¯‰æ•°',
            'æ¸©åº¦',
          ]

          // æ¨¡æ‹Ÿç‰¹å¾é‡è¦æ€§ï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦é€šè¿‡æ’åˆ—é‡è¦æ€§ç­‰æ–¹æ³•è®¡ç®—ï¼‰
          return featureNames
            .map((name, index) => ({
              name: name,
              importance: 0.3 + Math.random() * 0.7, // æ¨¡æ‹Ÿé‡è¦æ€§åˆ†æ•°
            }))
            .sort((a, b) => b.importance - a.importance)
        }
      }

      // å…¨å±€å˜é‡
      let dataGenerator = new PowerGridDataGenerator()
      let predictionModel = new ComplaintPredictionModel()
      let currentGrids = []

      // å¼€å§‹è®­ç»ƒæ¨¡å‹
      async function startTraining() {
        try {
          document.getElementById('trainingStatus').innerHTML =
            'ç”Ÿæˆè®­ç»ƒæ•°æ®ä¸­...'

          // ç”Ÿæˆè®­ç»ƒæ•°æ®
          const trainingData = dataGenerator.generateTrainingData(5000)
          document.getElementById('trainingStatus').innerHTML =
            'æ•°æ®ç”Ÿæˆå®Œæˆï¼Œå¼€å§‹è®­ç»ƒæ¨¡å‹...'

          // è®­ç»ƒæ¨¡å‹
          await predictionModel.train(
            trainingData.features,
            trainingData.labels,
            50
          )

          document.getElementById('trainingStatus').innerHTML =
            '<span style="color: green;">âœ… æ¨¡å‹è®­ç»ƒå®Œæˆï¼</span>'
          document.getElementById('modelMetrics').innerHTML =
            'æ¨¡å‹å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹é¢„æµ‹ç½‘æ ¼é£é™©'

          // æ¸…ç†å†…å­˜
          trainingData.features.dispose()
          trainingData.labels.dispose()
        } catch (error) {
          console.error('è®­ç»ƒå¤±è´¥:', error)
          document.getElementById(
            'trainingStatus'
          ).innerHTML = `<span style="color: red;">è®­ç»ƒå¤±è´¥: ${error.message}</span>`
        }
      }

      // ç”Ÿæˆé¢„æµ‹ç»“æœ
      async function generatePredictions() {
        if (!predictionModel.isTrained) {
          alert('è¯·å…ˆè®­ç»ƒæ¨¡å‹ï¼')
          return
        }

        try {
          document.getElementById('predictions').innerHTML = 'é¢„æµ‹ä¸­...'

          // ç”Ÿæˆæ¨¡æ‹Ÿç½‘æ ¼æ•°æ®
          currentGrids = dataGenerator.generatePredictionData(15)

          // è¿›è¡Œé¢„æµ‹
          const predictions = await predictionModel.predict(currentGrids)

          // æ˜¾ç¤ºé¢„æµ‹ç»“æœ
          displayPredictions(predictions)

          // æ˜¾ç¤ºç‰¹å¾é‡è¦æ€§
          displayFeatureImportance()
        } catch (error) {
          console.error('é¢„æµ‹å¤±è´¥:', error)
          document.getElementById(
            'predictions'
          ).innerHTML = `<span style="color: red;">é¢„æµ‹å¤±è´¥: ${error.message}</span>`
        }
      }

      // æ˜¾ç¤ºé¢„æµ‹ç»“æœ
      function displayPredictions(predictions) {
        let html = ''

        predictions.forEach((grid) => {
          const cardClass =
            grid.riskScore > 0.7
              ? 'high-risk'
              : grid.riskScore > 0.4
              ? 'medium-risk'
              : ''

          html += `
                <div class="card ${cardClass}">
                    <h4>${grid.id} 
                        <span class="risk-indicator ${grid.riskClass}">
                            ${grid.riskLevel} (${(grid.riskScore * 100).toFixed(
            1
          )}%)
                        </span>
                    </h4>
                    <p>ç‰¹å¾: äººå£å¯†åº¦ ${(grid.features[0] * 100).toFixed(1)}%, 
                        è´Ÿè½½ç‡ ${(grid.features[1] * 100).toFixed(1)}%, 
                        ç‰¹æ®Šç¾¤ä½“ ${(grid.features[3] * 100).toFixed(1)}%</p>
                </div>
                `
        })

        document.getElementById('predictions').innerHTML = html
      }

      // æ˜¾ç¤ºç‰¹å¾é‡è¦æ€§
      function displayFeatureImportance() {
        const importance = predictionModel.getFeatureImportance()
        let html = ''

        importance.forEach((feature) => {
          const width = feature.importance * 100 + '%'
          html += `
                <div class="feature-bar">
                    <div class="feature-name">${feature.name}</div>
                    <div class="feature-value">
                        <div class="feature-fill" style="width: ${width}"></div>
                    </div>
                    <div style="width: 60px; text-align: right;">
                        ${(feature.importance * 100).toFixed(1)}%
                    </div>
                </div>
                `
        })

        document.getElementById('featureImportance').innerHTML = html
      }

      // é‡ç½®æ¨¡å‹
      function resetModel() {
        predictionModel = new ComplaintPredictionModel()
        document.getElementById('trainingStatus').innerHTML =
          'æ¨¡å‹å·²é‡ç½®ï¼Œå‡†å¤‡å¼€å§‹è®­ç»ƒ...'
        document.getElementById('trainingProgress').innerHTML = ''
        document.getElementById('modelMetrics').innerHTML = ''
        document.getElementById('predictions').innerHTML = ''
        document.getElementById('featureImportance').innerHTML = ''
      }

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function () {
        console.log('æ•æ„Ÿäººç¾¤åŠ¨æ€ä¿ç”µé¢„æµ‹ç³»ç»Ÿå·²åˆå§‹åŒ–')
        console.log('ç‚¹å‡»"å¼€å§‹è®­ç»ƒæ¨¡å‹"æ¥è®­ç»ƒç¥ç»ç½‘ç»œ')
      })
    </script>
  </body>
</html>
